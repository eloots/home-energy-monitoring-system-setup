# Telegraf Configuration
#
# Telegraf is entirely plugin driven. All metrics are gathered from the
# declared inputs, and sent to the declared outputs.
#
# Plugins must be declared in here to be active.
# To deactivate a plugin, comment out the name and any variables.
#
# Use 'telegraf -config telegraf.conf -test' to see what metrics a config
# file would generate.
#
# Environment variables can be used anywhere in this config file, simply surround
# them with ${}. For strings the variable must be within quotes (ie, "${STR_VAR}"),
# for numbers and booleans they should be plain (ie, ${INT_VAR}, ${BOOL_VAR})


[global_tags]
[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = ""
  hostname = ""
  omit_hostname = false

[[outputs.influxdb]]
  namepass = ["smappee-data-2"]
  alias = "smappee-out-2"
  urls = ["http://192.168.68.201:8086"]
  database = "smappee_monitoring_2"
  username = "demo"
  password = "demo"


[[inputs.mqtt_consumer]]
  alias = "smappee-2"
  name_override = "smappee-data-2"
  servers = ["tcp://192.168.68.201:1883"]
  topics = [
    "servicelocation/5aaf6e89-89cb-4e33-bf34-05abc62f5563/realtime"
  ]
  # The "host" tag is irrelevant in this use case. Drop it
  tagexclude = ["host"]
  data_format = "json_v2"
  [[inputs.mqtt_consumer.json_v2]]
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500053415/0$).power"
      rename = "verdieping-1-stopkontakten"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500053415/0$).cosPhi"
      rename = "verdieping-1-stopkontakten-cosPhi"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500053415/0$).apparentPower"
      rename = "verdieping-1-stopkontakten-apparentPower"
      type = "float"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500053415/1$).power"
      rename = "garage"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500053415/1$).cosPhi"
      rename = "garage-cosPhi"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500053415/1$).apparentPower"
      rename = "garage-apparentPower"
      type = "float"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047903/0$).power"
      rename = "fornuis"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047903/0$).cosPhi"
      rename = "fornuis-cosPhi"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047903/0$).apparentPower"
      rename = "fornuis-apparentPower"
      type = "float"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047903/1$).power"
      rename = "oven"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047903/1$).cosPhi"
      rename = "oven-cosPhi"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047903/1$).apparentPower"
      rename = "oven-apparentPower"
      type = "float"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047903/2$).power"
      rename = "gelijkvloers-stopkontakten"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047903/2$).cosPhi"
      rename = "gelijkvloers-stopkontakten-cosPhi"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047903/2$).apparentPower"
      rename = "gelijkvloers-stopkontakten-apparentPower"
      type = "float"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047903/3$).power"
      rename = "vaatwasser"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047903/3$).cosPhi"
      rename = "vaatwasser-cosPhi"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047903/3$).apparentPower"
      rename = "vaatwasser-apparentPower"
      type = "float"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500048161/0$).power"
      rename = "zolder-verlichting"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500048161/0$).cosPhi"
      rename = "zolder-verlichting-cosPhi"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500048161/0$).apparentPower"
      rename = "zolder-verlichting-apparentPower"
      type = "float"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500048161/1$).power"
      rename = "zolder-stopkontakten-network-switch"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500048161/1$).cosPhi"
      rename = "zolder-stopkontakten-network-switch-cosPhi"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500048161/1$).apparentPower"
      rename = "zolder-stopkontakten-network-switch-apparentPower"
      type = "float"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500048161/2$).power"
      rename = "tuinhuis-fietsgarage"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500048161/2$).cosPhi"
      rename = "tuinhuis-fietsgarage-cosPhi"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500048161/2$).apparentPower"
      rename = "tuinhuis-fietsgarage-apparentPower"
      type = "float"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500048161/3$).power"
      rename = "airco-zolder-en-slaapkamer"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500048161/3$).cosPhi"
      rename = "airco-zolder-en-slaapkamer-cosPhi"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500048161/3$).apparentPower"
      rename = "airco-zolder-en-slaapkamer-apparentPower"
      type = "float"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047926/0$).power"
      rename = "zolder-stopkontakten-printer"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047926/0$).cosPhi"
      rename = "zolder-stopkontakten-printer-cosPhi"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047926/0$).apparentPower"
      rename = "zolder-stopkontakten-printer-apparentPower"
      type = "float"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047926/1$).power"
      rename = "zolder-bureau"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047926/1$).cosPhi"
      rename = "zolder-bureau-cosPhi"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047926/1$).apparentPower"
      rename = "zolder-bureau-apparentPower"
      type = "float"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047926/2$).power"
      rename = "zolder-zekeringkast"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047926/2$).cosPhi"
      rename = "zolder-zekeringkast-cosPhi"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "channelPowers.#(formula==$5500047926/2$).apparentPower"
      rename = "zolder-zekeringkast-apparentPower"
      type = "float"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "voltages.#(phaseId==0).voltage"
      rename = "voltage"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "measuredFrequency"
      rename = "measuredFrequency"
      type = "float"

[[processors.regex]]
  namepass = ["smappee-data-2"]
  [[processors.regex.tags]]
    key = "topic"
    pattern = ".*/(.*)/.*"
    replacement = "smappee/${1}"

# Keep the aggregate basicstats of each metric passing through.
[[aggregators.basicstats]]
  namepass = ["smappee-data-2"]
  ## The period on which to flush & clear the aggregator.
  period = "60s"

  ## If true, the original metric will be dropped by the
  ## aggregator and will not get sent to the output plugins.
  drop_original = true

  ## Configures which basic stats to push as fields
  stats = ["mean"]
